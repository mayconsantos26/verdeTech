<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link href="../src/css/bootstrap.min.css" rel="stylesheet">
    <script src="../src/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="../src/css/style.css">

    <title>VerdeTech Farm - Meu Carrinho</title>
    <link rel="icon" href="../src/img/logo.ico" type="image/x-icon">
</head>
<body>
    <header>
        <div id="header"></div> <!-- Inclui o header através do JavaScript -->
    </header> 

    <main>
        <section class="container">
            <div class="d-flex align-items-center mb-5">
                <p class="mr-2 mb-0" id="nomeUsuario"></p>
                <button id="logout" class="btn-logout">Sair</button>       
            </div>
            <h2>MEU CARRINHO</h2>
            <div id="cart-items" class="p-3 border rounded"><p>Carrinho vazio.</p></div>
            <div class="text-end mt-3" id="total"><strong>Total: </strong> R$ <span id="valor-total">0,00</span></div>
            <div class="mt-3">
                <button id="checkout" class="btn">Finalizar Compra</button>
            </div>
        </section>
    </main>

    <footer>
        <div id="footer"></div> <!-- Inclui o footer através do JavaScript -->
    </footer>

    <script>

        document.addEventListener('DOMContentLoaded', () => {
            const nomeUsuario = document.getElementById('nomeUsuario');
            const logoutBtn = document.getElementById('logout');

            // Verifica se existe um usuário logado no sessionStorage
            const usuarioLogado = JSON.parse(sessionStorage.getItem('usuarioLogado'));

            if (usuarioLogado) {
                // Se o usuário estiver logado, exibe o nome e o botão de logout
                nomeUsuario.textContent = `Bem-vindo(a), ${usuarioLogado.nome}!`;
                logoutBtn.style.display = 'block'; // Torna o botão de logout visível
            } else {
                // Se não houver usuário logado, o botão não aparece
                nomeUsuario.textContent = 'Você não está logado.';
                logoutBtn.style.display = 'none'; // Oculta o botão de logout
            }

            // Adiciona a funcionalidade de logout
            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('usuarioLogado'); // Remove o usuário da sessão
                alert('Você saiu da sua conta.');
                window.location.href = 'login.html'; // Redireciona para a página de login
            });
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const cartItemsContainer = document.getElementById('cart-items');
            const checkoutButton = document.getElementById('checkout');
            const cartCounter = document.getElementById('cart-counter');
            const totalElement = document.getElementById('valor-total');

            // Recupera itens do carrinho do localStorage
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            function updateCartCounter() {
                cartCounter.textContent = cart.length;
                cartCounter.style.display = cart.length > 0 ? 'inline-block' : 'none';
            }

            function renderCartItems() {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<p>Carrinho vazio.</p>';
                    checkoutButton.disabled = true;
                    return;
                }
                cart.forEach((item, index) => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item d-flex justify-content-between align-items-center p-2 border-bottom';
                    cartItem.innerHTML = `
                        <div class="d-flex align-items-center">
                            <img src="${item.image}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
                            <span>${item.name}</span>
                        </div>
                        <div>
                            <span class="preco-item">${item.price}</span>
                            <button class="btn-carrinho btn-danger btn-sm ml-2" data-index="${index}">Remover</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItem);
                });
                checkoutButton.disabled = false;
                addRemoveEventListeners();
            }

            function calcularTotal() {
                let total = cart.reduce((acc, item) => {
                    const valorTexto = item.price.replace('R$', '').replace(',', '.');
                    return acc + parseFloat(valorTexto);
                }, 0);
                totalElement.textContent = total.toFixed(2).replace('.', ',');
            }

            function removeItem(index) {
                cart.splice(index, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCartItems();
                calcularTotal();
                updateCartCounter();
            }

            function addRemoveEventListeners() {
                document.querySelectorAll('.cart-item .btn-danger').forEach((button) => {
                    button.addEventListener('click', () => {
                        const index = button.getAttribute('data-index');
                        removeItem(index);
                    });
                });
            }

            checkoutButton.addEventListener('click', () => {
                if (cart.length === 0) {
                    alert('Seu carrinho está vazio.');
                    return;
                }
                sessionStorage.setItem('currentOrder', JSON.stringify(cart));
                window.location.href = 'pagamento.html';
            });

            // Sincroniza carrinho entre abas
            window.addEventListener('storage', () => {
                cart = JSON.parse(localStorage.getItem('cart')) || [];
                renderCartItems();
                calcularTotal();
                updateCartCounter();
            });

            renderCartItems();
            calcularTotal();
            updateCartCounter();
        });
    </script>
    
    <script src="../src/js/include.js"></script>
</body> 
</html>
