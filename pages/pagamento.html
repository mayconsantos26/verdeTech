<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link href="src/css/bootstrap.min.css" rel="stylesheet">
    <script src="src/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>VerdeTech Farm - Pagamento</title>
    <link rel="icon" href="img/logo.ico" type="image/x-icon">
</head>
<body>
    <header>
        <nav class="d-flex justify-content-between align-items-center container py-3">
            <div class="logo">
                <a href="index.html"><img src="img/logo.png" alt=""></a>
            </div>
            <div>
                <ul class="d-flex justify-content-center align-items-center">
                    <li>
                        <a href="index.html">INÍCIO</a>
                    </li>
                    <li>
                        <a href="produtos.html">PRODUTOS</a>
                    </li>
                    <li>    
                        <a href="entrega.html">ENTREGA</a>
                    </li>
                    <li>
                        <a href="contato.html">FALE CONOSCO</a>
                    </li>
                </ul>       
            </div>
            <div class="d-flex">
                <ul>
                    <li class="mr-0 position-relative">
                        <a href="carrinho.html">
                            <img src="../img/carrinho-de-compras.png" alt="Carrinho">
                            <span id="cart-counter" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                0
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="login.html"><img src="../img/perfil.png" alt="Perfil"></a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="container">
            <div class="d-flex align-items-center mb-5">
                <p class="mr-2 mb-0" id="nomeUsuario"></p>
                <button id="logout" class="btn-logout">Sair</button>       
            </div>
            <h1>Resumo da Compra</h1>
            <div id="resumo-compra"></div>
            <h3>Total: <span id="total-pagamento">R$ 0,00</span></h3>

            <form id="pagamento-form" class="mt-4">
                <div class="form-group">
                    <label for="nome">Nome do Titular</label>
                    <input type="text" id="nome" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="cartao">Número do Cartão</label>
                    <input type="text" id="cartao" class="form-control" maxlength="16" required>
                </div>
                <div class="form-group">
                    <label for="validade">Validade</label>
                    <input type="month" id="validade" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="cvv">CVV</label>
                    <input type="text" id="cvv" class="form-control" maxlength="3" required>
                </div>
                <button type="submit" class="btn btn-success btn-block">Realizar Pagamento</button>
            </form>
        </section>

        <script>

            document.addEventListener('DOMContentLoaded', () => {
                const nomeUsuario = document.getElementById('nomeUsuario');
                const logoutBtn = document.getElementById('logout');

                // Verifica se existe um usuário logado no sessionStorage
                const usuarioLogado = JSON.parse(sessionStorage.getItem('usuarioLogado'));

                if (usuarioLogado) {
                    // Se o usuário estiver logado, exibe o nome e o botão de logout
                    nomeUsuario.textContent = `Bem-vindo(a), ${usuarioLogado.nome}!`;
                    logoutBtn.style.display = 'block'; // Torna o botão de logout visível
                } else {
                    // Se não houver usuário logado, o botão não aparece
                    nomeUsuario.textContent = 'Você não está logado.';
                    logoutBtn.style.display = 'none'; // Oculta o botão de logout
                }

                // Adiciona a funcionalidade de logout
                logoutBtn.addEventListener('click', () => {
                    sessionStorage.removeItem('usuarioLogado'); // Remove o usuário da sessão
                    alert('Você saiu da sua conta.');
                    window.location.href = 'login.html'; // Redireciona para a página de login
                });
            });

            document.addEventListener('DOMContentLoaded', () => {
                const resumoCompra = document.getElementById('resumo-compra');
                const totalPagamento = document.getElementById('total-pagamento');
                const pagamentoForm = document.getElementById('pagamento-form');

                const cart = JSON.parse(sessionStorage.getItem('currentOrder')) || [];

                if (cart.length === 0) {
                    alert('Carrinho vazio. Redirecionando...');
                    window.location.href = 'carrinho.html';
                    return;
                }

                function renderResumoCompra() {
                    resumoCompra.innerHTML = '';
                    let total = 0;
                    cart.forEach((item) => {
                        const div = document.createElement('div');
                        div.className = 'resumo-item d-flex justify-content-between align-items-center mb-2';
                        div.innerHTML = `<span>${item.name}</span><span>${item.price}</span>`;
                        resumoCompra.appendChild(div);
                        total += parseFloat(item.price.replace('R$', '').replace(',', '.'));
                    });
                    totalPagamento.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                }

                function validarFormulario() {
                    const numeroCartao = document.getElementById('cartao').value;
                    const cvv = document.getElementById('cvv').value;

                    if (!/^\d{16}$/.test(numeroCartao)) {
                        alert('Número do cartão inválido. Insira 16 dígitos.');
                        return false;
                    }
                    if (!/^\d{3}$/.test(cvv)) {
                        alert('CVV inválido. Insira 3 dígitos.');
                        return false;
                    }
                    return true;
                }

                pagamentoForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (validarFormulario()) {
                        alert('Pagamento realizado com sucesso!');
                        sessionStorage.removeItem('currentOrder');
                        window.location.href = 'index.html'; // Redireciona para a página inicial
                    }
                });

                renderResumoCompra();
            });
        </script>
    </main>
</body>
</html>
